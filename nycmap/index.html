<!DOCTYPE html>
<html>
<head>
	<meta charset=utf-8 />
	<title>City Planning Facilities Map</title>
	<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
	<script src='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.js'></script>
	<link type="text/css" href="colorbrewer.css" rel="stylesheet">
	<script type="text/javascript" src="d3/d3.min.js"></script>
	<script type="text/javascript" src="colorbrewer.js"></script>
	<script type="text/javascript" src="jquery/jquery-2.1.4.min.js"></script>
	<script type="text/javascript" src="cssmenu/script.js"></script>
	
	<link href='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.css' rel='stylesheet' />
	<link rel="stylesheet" href= "style.css" />
	<link rel="stylesheet" href= "cssmenu/styles.css" />
	<style>
	  
	  #map { position:absolute; top:0; bottom:0; width:100%;height: 100%; }
	</style>
</head>
<body>
	<style>

	</style>

	<!-- jQuery is required for this example. -->
	<script src='https://code.jquery.com/jquery-1.11.0.min.js'></script>
	<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>

	<div id='map'></div>

	<div id='control_container'>
		<div id='title_box'>
			<h1 id='control_title'> City Planning Facilities Database</h1>
			<h5><a id="about_toggle" >About the Data
			    <div class="popup">
								    ABOUT THE DATA <br>
					The City Planning Facilities Database is a ‘one-stop shop’ for information about more than 12,000 public facilities and program sites in the City of New York.  The Department of City Planning aggregates these data from 49 different City, State, and Federal agencies to facilitate collaborative planning efforts across government and in the private sector. 
					The sites included in this dataset are those at which government operates, funds, or licenses the provision of public services.  City Planning builds on agencies’ datasets by geocoding all locations, reporting on common attributes, and grouping facilities into six user-friendly categories.  The data are used regularly in neighborhood planning, facility and program siting decisions, and a host of other purposes across government. 
					In addition to this interactive map, the City Planning Facilities Database is available for download in multiple formats from Bytes of the Big Apple.  Sign up to be notified of updates here, and please let us know how you use the data by emailing the Capital Planning division at City Planning at capital@planning.nyc.gov.<br><br>
					LIMITATIONS <br>
					The Department of City Planning cannot guarantee that the Facilities Database is comprehensive or includes the latest information about any of the facilities encompassed in the database.  The Facilities Database is limited by the reliability of each contributing agency’s data and the Department of City Planning’s quarterly update schedule.  The Department of City Planning strongly encourages users to read the metadata.  This database is a product that is consistently evolving, and the Department of City Planning actively works to improve its quality and usability.  Any specific ideas for improvement or questions about the data should be directed to capital@planning.nyc.gov.
				</div>
			    
			</a></h5>
			<input id='search' class='search-ui' placeholder='Search' />
		</div>
		<div id='cssmenu'>
			<ul id='grouplist'>
			   <li class='active' ><a class='group' id='all' href='#' data-filter='all'>Show All</a>
			   </li>
			   
			</ul>
		</div>
	</div>

	<script>
		$("#about_toggle").on("mouseover", function(e){
		    e.preventDefault();
		    $(this).find(".popup").fadeIn("slow");
		});

		$("#about_toggle").on("mouseout", function(e){
			e.preventDefault();
			$(this).find(".popup").fadeOut("slow");
		});

		var categories = {
			"Educational Facilities": {},
			"Community & Recreational Facilities": {},
			"Public Safety & Justice Facilities": {},
			"Hospitals & Health Service Facilities": {},
			"Housing & Social Service Facilities": {},
			"Transportation & Waste Facilities": {}
		};

		L.mapbox.accessToken = 'pk.eyJ1Ijoia2phY2tzIiwiYSI6ImNpaGNqZzg3MzA3b3p1ZW1henJmdHFwcXcifQ.8VPtPnB9QdLxxAU2mXDpfw';

		var map = L.map('map', {
		    scrollWheelZoom: true,
		    zoomControl: false,
		    center: [40.7127837, -74.0059413],
		    zoom: 11
		});

		//new L.Control.Zoom({ position: 'topright' }).addTo(map);

		var layer = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
		  attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
		}).addTo(map);

		$('#search').keyup(search);

		var colorScale = [null,"#031D44", "#78BC41","#7CAEF0", "#69DDFF", "#227159", "#708471"];

		var feat_layer_options = {
			pointToLayer: function (feature, latlng) {
				return L.circleMarker(latlng, {
					stroke: false,
					fillColor: colorScale[feature.properties.NewGroupType],
					fillOpacity: .6, 
					
				}).setRadius(3.5).bindPopup(feature.properties.FacName);
			}
		}

		var csvLayer = omnivore.csv('sfpsd.csv', null, L.mapbox.featureLayer(null, feat_layer_options))
			.on('ready', function(layer) {
				var i = 0;
				this.eachLayer(function(marker) {
					i++;
					var group = marker.feature.properties.NewGroupType_Decode;
					var subgroup = marker.feature.properties.NewSgroup_Decode;

					group.toString();
					subgroup.toString();

					categories[group][subgroup] = {}; 
				});
				console.log(i);
				addFilters();
			/*
	        // An example of customizing marker styles based on an attribute.
	        // In this case, the data, a CSV file, has a column called 'state'
	        // with values referring to states. Your data might have different
	        // values, so adjust to fit.
		        this.eachLayer(function(marker) {
		        	/console.log(marker);
		            if (marker.toGeoJSON().properties.FacName === 'CA') {
		                // The argument to L.mapbox.marker.icon is based on the
		                // simplestyle-spec: see that specification for a full
		                // description of options.
		                marker.setIcon(L.mapbox.marker.icon({
		                    'marker-color': '#ff8888',
		                    'marker-size': 'large'
		                }));
		            } else {
		            	
		                marker.setIcon(circleIcon);

		            //}
		    		
		            // Bind a popup to each icon based on the same properties
		            marker.bindPopup(marker.toGeoJSON().properties.FacName + ', ' +
		                marker.toGeoJSON().properties.Borough);
		            
		        });*/
	    	})
			.on('error', function(e) {
		        // fired if the layer can't be loaded over AJAX
		        // or can't be parsed
		        console.log(e);
		    })
		    .addTo(map);

		function addFilters() {
			//agency_over.forEach(function(a) {
			var i = 1;
			for(group in categories) {

				var h = "<li class='has-sub'><a class='group' id='g" + i + "' href='#' data-filter='" + group + "'>"+ group + " <div class='tab'></div></a><ul>";

				for (subgroup in categories[group]) {
					
					h += "<li><a class='subgroup' href='#' data-filter='" + subgroup + "'>"+ subgroup + "</a></li>";
				}

				h += "</ul></li>";
				$('#grouplist').append(h);
				i++;
			};
		      
		    //  currFilters.agency_over.push(a);
		    //}); 

			

			for (var i = 0; i < categories.length; i++) {
				console.log(categories[i]);
			}

			addFilterInteraction();
		}

		function search() {
		    // get the value of the search input field
		    var searchString = $('#search').val().toLowerCase();

		   	csvLayer.setFilter(showState);

		   	/*csvLayer.eachLayer(function(marker) {
		   			console.log(marker);
		            marker.openPopup();
		        });
		       */

		   	console.log(csvLayer);
		    // here we're simply comparing the 'state' property of each marker
		    // to the search string, seeing whether the former contains the latter.
		    function showState(feature) {
		    	//console.log(feature);
		        return feature.properties.FacName
		            .toLowerCase()
		            .indexOf(searchString) !== -1;
		    }
		}

		
	</script>
	
</body>
</html>