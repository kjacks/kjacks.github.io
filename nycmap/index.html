<!DOCTYPE html>
<html>
<head>
	<meta charset=utf-8 />
	<title>NYC Facilities Map</title>
	<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
	<script src='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.js'></script>
	<link type="text/css" href="colorbrewer.css" rel="stylesheet">
	<script type="text/javascript" src="d3/d3.min.js"></script>
	<script type="text/javascript" src="colorbrewer.js"></script>
	<script type="text/javascript" src="jquery/jquery-2.1.4.min.js"></script>
	<script type="text/javascript" src="cssmenu/script.js"></script>
	
	<link href='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.css' rel='stylesheet' />
	<link rel="stylesheet" href= "style.css" />
	<link rel="stylesheet" href= "cssmenu/styles.css" />
	<style>
	  body { margin:0; padding:0; }
	  #map { position:absolute; top:0; bottom:0; width:100%; }
	</style>
</head>
<body>
	<style>

	</style>

	<!-- jQuery is required for this example. -->
	<script src='https://code.jquery.com/jquery-1.11.0.min.js'></script>
	<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>

	<div id='map'></div>

	<div id='controls'>
		<input id='search' class='search-ui' placeholder='Enter Facility Name' />
		<div id='cssmenu'>
			<ul id='grouplist'>
			   <li class='active' ><a class='group' href='#' data-filter='all'>Show All</a></li>
			   
			</ul>
		</div>
	</div>

	<script>

		var categories = {
			"Educational Facilities": {},
			"Community & Recreational Facilities": {},
			"Hospitals & Health Service Facilities": {},
			"Public Safety & Justice Facilities": {},
			"Transportation & Waste Facilities": {},
			"Housing & Social Service Facilities": {}
		};

		L.mapbox.accessToken = 'pk.eyJ1Ijoia2phY2tzIiwiYSI6ImNpaGNqZzg3MzA3b3p1ZW1henJmdHFwcXcifQ.8VPtPnB9QdLxxAU2mXDpfw';

		var map = L.map('map', {
		    scrollWheelZoom: true,
		    zoomControl: false,
		    center: [40.7127837, -74.0059413],
		    zoom: 11
		});

		new L.Control.Zoom({ position: 'topright' }).addTo(map);

		var layer = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
		  attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
		}).addTo(map);

		$('#search').keyup(search);

		var colorScale = d3.scale.ordinal()
	        .domain([1, 6])
	        .range(["#AD8607", "#3B4BAD","#3F78B8", "#3F8EA1", "#3FB8A4", "#35AD6F"]);

		var feat_layer_options = {
			pointToLayer: function (feature, latlng) {
				//console.log(feature);
				var fill_col = colorScale(feature.properties.NewGroupType);
				return L.circleMarker(latlng, {
					stroke: false,
					fillColor: fill_col,
					fillOpacity: 1, 
					
				}).setRadius(4).bindPopup(feature.properties.FacName);
			}
		}

		var csvLayer = omnivore.csv('new-subset.csv', null, L.mapbox.featureLayer(null, feat_layer_options))
			.on('ready', function(layer) {
				console.log(layer);
				this.eachLayer(function(marker) {
					var group = marker.feature.properties.NewGroupType_Decode;
					var subgroup = marker.feature.properties.NewSgroup_Decode;

					group.toString();
					subgroup.toString();

					categories[group][subgroup] = {}; 
				});
				addFilters();
			/*
	        // An example of customizing marker styles based on an attribute.
	        // In this case, the data, a CSV file, has a column called 'state'
	        // with values referring to states. Your data might have different
	        // values, so adjust to fit.
		        this.eachLayer(function(marker) {
		        	/console.log(marker);
		            if (marker.toGeoJSON().properties.FacName === 'CA') {
		                // The argument to L.mapbox.marker.icon is based on the
		                // simplestyle-spec: see that specification for a full
		                // description of options.
		                marker.setIcon(L.mapbox.marker.icon({
		                    'marker-color': '#ff8888',
		                    'marker-size': 'large'
		                }));
		            } else {
		            	
		                marker.setIcon(circleIcon);

		            //}
		    		
		            // Bind a popup to each icon based on the same properties
		            marker.bindPopup(marker.toGeoJSON().properties.FacName + ', ' +
		                marker.toGeoJSON().properties.Borough);
		            
		        });*/
	    	})
		    .addTo(map);

		function addFilters() {
			//agency_over.forEach(function(a) {
			for(group in categories) {

				var h = "<li class='has-sub'><a class='group' href='#' data-filter='" + group + "'>"+ group + "</a> <ul>";

				for (subgroup in categories[group]) {
					console.log(subgroup);
					h += "<li><a class='subgroup' href='#' data-filter='" + subgroup + "'>"+ subgroup + "</a></li>";
				}

				h += "</ul></li>";
				$('#grouplist').append(h);
			};
		      
		    //  currFilters.agency_over.push(a);
		    //}); 

			console.log();

			for (var i = 0; i < categories.length; i++) {
				console.log(categories[i]);
			}

			addFilterInteraction();
		}

		function search() {
		    // get the value of the search input field
		    var searchString = $('#search').val().toLowerCase();

		    console.log(csvLayer);
		   	csvLayer.setFilter(showState);

		   	/*csvLayer.eachLayer(function(marker) {
		   			console.log(marker);
		            marker.openPopup();
		        });
		       */

		   	console.log(csvLayer);
		    // here we're simply comparing the 'state' property of each marker
		    // to the search string, seeing whether the former contains the latter.
		    function showState(feature) {
		    	//console.log(feature);
		        return feature.properties.FacName
		            .toLowerCase()
		            .indexOf(searchString) !== -1;
		    }
		}

		
	</script>
	
</body>
</html>